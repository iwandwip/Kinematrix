<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Manager</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>WiFi Manager</h1>
            <p>ESP32 Network Configuration</p>
        </div>

        <div class="status-card" id="statusCard">
            <div class="status-icon" id="statusIcon">üì∂</div>
            <div class="status-text">
                <div id="statusMessage">Initializing...</div>
                <div id="statusDetails"></div>
            </div>
        </div>

        <div class="card">
            <h2>Available Networks</h2>
            <button class="btn btn-secondary" onclick="scanNetworks()">üîÑ Scan Networks</button>
            <div id="networkList" class="network-list">
                <div class="loading">Scanning networks...</div>
            </div>
        </div>

        <div class="card">
            <h2>WiFi Configuration</h2>
            <form id="wifiForm">
                <div class="form-group">
                    <label for="ssid">Network Name (SSID):</label>
                    <input type="text" id="ssid" name="ssid" required>
                </div>

                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password">
                </div>

                <div class="form-group">
                    <input type="checkbox" id="showPassword" onchange="togglePassword()">
                    <label for="showPassword">Show Password</label>
                </div>

                <details class="advanced-settings">
                    <summary>‚öôÔ∏è Advanced Settings</summary>
                    <div class="form-group">
                        <label for="ip">Static IP Address:</label>
                        <input type="text" id="ip" name="ip" placeholder="192.168.1.100">
                    </div>
                    <div class="form-group">
                        <label for="gateway">Gateway:</label>
                        <input type="text" id="gateway" name="gateway" placeholder="192.168.1.1">
                    </div>
                    <div class="form-group">
                        <label for="subnet">Subnet Mask:</label>
                        <input type="text" id="subnet" name="subnet" placeholder="255.255.255.0">
                    </div>
                </details>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Connect</button>
                    <button type="button" class="btn btn-danger" onclick="resetConfig()">Reset</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let statusInterval;

        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const statusIcon = document.getElementById('statusIcon');
                    const statusMessage = document.getElementById('statusMessage');
                    const statusDetails = document.getElementById('statusDetails');
                    const statusCard = document.getElementById('statusCard');

                    if (data.connected) {
                        statusIcon.textContent = '‚úÖ';
                        statusMessage.textContent = 'Connected';
                        statusDetails.innerHTML = `SSID: ${data.ssid}<br>IP: ${data.ip}<br>Signal: ${data.quality}%`;
                        statusCard.className = 'status-card connected';
                    } else if (data.configMode) {
                        statusIcon.textContent = '‚öôÔ∏è';
                        statusMessage.textContent = 'Configuration Mode';
                        statusDetails.textContent = 'Please configure WiFi settings';
                        statusCard.className = 'status-card config';
                    } else {
                        statusIcon.textContent = '‚ùå';
                        statusMessage.textContent = 'Disconnected';
                        statusDetails.textContent = 'Not connected to any network';
                        statusCard.className = 'status-card disconnected';
                    }
                })
                .catch(() => {
                    document.getElementById('statusIcon').textContent = '‚ö†Ô∏è';
                    document.getElementById('statusMessage').textContent = 'Connection Error';
                    document.getElementById('statusDetails').textContent = 'Unable to get status';
                });
        }

        function scanNetworks() {
            const networkList = document.getElementById('networkList');
            networkList.innerHTML = '<div class="loading">üîÑ Scanning networks...</div>';

            fetch('/scan')
                .then(response => response.json())
                .then(data => {
                    networkList.innerHTML = '';
                    if (data.networks && data.networks.length > 0) {
                        data.networks.forEach(network => {
                            const networkItem = document.createElement('div');
                            networkItem.className = 'network-item';
                            networkItem.onclick = () => selectNetwork(network.ssid);

                            const signalBars = getSignalBars(network.quality);
                            const lockIcon = network.encryption === 'open' ? 'üîì' : 'üîí';

                            networkItem.innerHTML = `
                                <div class="network-info">
                                    <div class="network-name">${network.ssid}</div>
                                    <div class="network-details">${lockIcon} ${network.encryption}</div>
                                </div>
                                <div class="network-signal">
                                    <div class="signal-bars">${signalBars}</div>
                                    <div class="signal-quality">${network.quality}%</div>
                                </div>
                            `;

                            networkList.appendChild(networkItem);
                        });
                    } else {
                        networkList.innerHTML = '<div class="no-networks">No networks found</div>';
                    }
                })
                .catch(() => {
                    networkList.innerHTML = '<div class="error">Failed to scan networks</div>';
                });
        }

        function getSignalBars(quality) {
            const bars = Math.ceil(quality / 25);
            let html = '';
            for (let i = 1; i <= 4; i++) {
                html += `<div class="bar ${i <= bars ? 'active' : ''}"></div>`;
            }
            return html;
        }

        function selectNetwork(ssid) {
            document.getElementById('ssid').value = ssid;
            document.querySelectorAll('.network-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.network-item').classList.add('selected');
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const checkbox = document.getElementById('showPassword');
            passwordInput.type = checkbox.checked ? 'text' : 'password';
        }

        function resetConfig() {
            if (confirm('Are you sure you want to reset all WiFi settings?')) {
                fetch('/reset', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                    })
                    .catch(() => {
                        alert('Reset failed');
                    });
            }
        }

        document.getElementById('wifiForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const button = document.querySelector('button[type="submit"]');
            const originalText = button.textContent;
            
            button.textContent = 'Connecting...';
            button.disabled = true;

            fetch('/connect', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Configuration saved! Device will restart...');
                } else {
                    alert('Error: ' + data.message);
                    button.textContent = originalText;
                    button.disabled = false;
                }
            })
            .catch(() => {
                alert('Connection failed');
                button.textContent = originalText;
                button.disabled = false;
            });
        });

        updateStatus();
        scanNetworks();
        statusInterval = setInterval(updateStatus, 5000);
    </script>
</body>
</html>